#nestjs #rmq

## Код Добавление библиотеки контрактов

Наша цель - реализовать контракты между микросервисами. В них мы описываем: что отправлять, куда отправлять и что получать назад. Контракты мы переиспользуем в разных микросервисах.

Генерируем через nx либу контрактов специально для nest-проектов:

```bash
nx g @nx/nest:lib contracts
```

И в пространствах имён будем описывать сущности, которые понадобятся нам для описания интерфейсов операций. 

Имя топика пишем по структуре:
>[!example] [микросервис].[комманда].[тип(command|event|request)] 

Мы используем namespace потому что для валидации запрос/ответа нужно использовать декораторы + классы

`libs / contracts / src / lib / account / account.login.ts`
```TS
import { IsEmail, IsString } from 'class-validator';

export namespace AccountLogin {
	// имя топика RMQ
	export const topic = 'account.login.command';

	// запрос
	export class Request {
		@IsEmail() // почта
		email: string;

		@IsString() // строка
		password: string;
	}

	// ответ
	export class Response {
		access_token: string;
	}
}
```



`libs / contracts / src / lib / account / account.register.ts`
```TS
import { IsEmail, IsOptional, IsString } from 'class-validator';

export namespace AccountRegister {
	export const topic = 'account.register.command';

	export class Request {
		@IsEmail()
		email: string;

		@IsString()
		password: string;

		@IsOptional()
		@IsString()
		displayName?: string;
	}

	export class Response {
		email: string;
	}
}
```

Далее подключаем namespace в качестве типов того, что придёт и вернётся из нашего контроллера.

`apps / account / src / app / auth / auth.controller.ts`
```TS
import { Body, Controller } from '@nestjs/common';
import { AccountLogin, AccountRegister } from '@purple/contracts';
import { RMQRoute, RMQValidate } from 'nestjs-rmq';
import { AuthService } from './auth.service';

@Controller()
export class AuthController {
	constructor(
		private readonly authService: AuthService
	) {}

	@RMQValidate()
	@RMQRoute(AccountRegister.topic)
	async register(@Body() dto: AccountRegister.Request): Promise<AccountRegister.Response> {
		return this.authService.register(dto);
	}

	@RMQValidate()
	@RMQRoute(AccountLogin.topic)
	async login(@Body() { email, password }: AccountLogin.Request): Promise<AccountLogin.Response> {
		const { id } = await this.authService.validateUser(email, password);
		return this.authService.login(id);
	}
}
```












## Код Разбор nestjsrmq









## Код Подключения rabbitmq к проекту










## Код Валидация запросов









